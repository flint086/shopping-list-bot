// Telegram Web App initialization
let tg = window.Telegram.WebApp;
let currentUser = null;

// Initialize Telegram Web App
tg.expand();
tg.MainButton.setText("Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼").onClick(syncWithBot);
tg.MainButton.show();

// Show user info if available
if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
    currentUser = tg.initDataUnsafe.user;
    document.getElementById('userInfo').textContent = `ÐŸÑ€Ð¸Ð²ÐµÑ‚, ${currentUser.first_name || 'Ð´Ñ€ÑƒÐ³'}!`;
}

// Load items from localStorage
function loadItems() {
    try {
        const items = JSON.parse(localStorage.getItem('shopping_items') || '[]');
        renderItems(items);
    } catch (error) {
        console.error('Error loading items:', error);
    }
}

// Add new item
function addItem() {
    const input = document.getElementById('itemInput');
    const text = input.value.trim();
    
    if (!text) return;
    
    // Handle multiple items separated by commas
    const itemsToAdd = text.split(',').map(item => item.trim()).filter(item => item);
    
    itemsToAdd.forEach(itemText => {
        if (itemText) {
            saveItem(itemText);
        }
    });
    
    input.value = '';
    loadItems();
}

// Save item to localStorage
function saveItem(text) {
    try {
        const items = JSON.parse(localStorage.getItem('shopping_items') || '[]');
        
        // Check for duplicates
        if (!items.find(item => item.text.toLowerCase() === text.toLowerCase())) {
            items.push({
                id: Date.now() + Math.random(),
                text: text,
                completed: false,
                createdAt: new Date().toISOString()
            });
            
            localStorage.setItem('shopping_items', JSON.stringify(items));
            return true;
        }
        return false;
    } catch (error) {
        console.error('Error saving item:', error);
        return false;
    }
}

// Toggle item completion
function toggleItem(id) {
    try {
        const items = JSON.parse(localStorage.getItem('shopping_items') || '[]');
        const item = items.find(item => item.id === id);
        
        if (item) {
            item.completed = !item.completed;
            localStorage.setItem('shopping_items', JSON.stringify(items));
            loadItems();
        }
    } catch (error) {
        console.error('Error toggling item:', error);
    }
}

// Delete item
function deleteItem(id) {
    try {
        let items = JSON.parse(localStorage.getItem('shopping_items') || '[]');
        items = items.filter(item => item.id !== id);
        localStorage.setItem('shopping_items', JSON.stringify(items));
        loadItems();
    } catch (error) {
        console.error('Error deleting item:', error);
    }
}

// Render items to the page
function renderItems(items) {
    const activeItems = items.filter(item => !item.completed);
    const completedItems = items.filter(item => item.completed);
    
    // Active items
    const activeContainer = document.getElementById('activeItems');
    activeContainer.innerHTML = '';
    activeItems.forEach(item => {
        activeContainer.appendChild(createItemElement(item));
    });
    
    // Completed items
    const completedContainer = document.getElementById('completedItems');
    completedContainer.innerHTML = '';
    completedItems.forEach(item => {
        completedContainer.appendChild(createItemElement(item));
    });
    
    // Show/hide sections
    document.getElementById('activeSection').style.display = activeItems.length ? 'block' : 'none';
    document.getElementById('completedSection').style.display = completedItems.length ? 'block' : 'none';
    document.getElementById('emptyState').style.display = items.length ? 'none' : 'block';
}

// Create item HTML element
function createItemElement(item) {
    const div = document.createElement('div');
    div.className = 'item';
    
    div.innerHTML = `
        <div class="item-content">
            <div class="checkbox ${item.completed ? 'checked' : ''}" onclick="toggleItem(${item.id})">
                ${item.completed ? 'âœ“' : ''}
            </div>
            <div class="item-text ${item.completed ? 'completed' : ''}">
                ${item.text}
            </div>
        </div>
        <button class="delete-btn" onclick="deleteItem(${item.id})">Ã—</button>
    `;
    
    return div;
}

// ðŸ”„ SYNCHRONIZATION FUNCTIONS

// Sync with bot - Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð±Ð¾Ñ‚Ñƒ
function syncWithBot() {
    const items = JSON.parse(localStorage.getItem('shopping_items') || '[]');
    
    // Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸
    const syncData = {
        action: 'sync_from_webapp',
        items: items,
        timestamp: new Date().toISOString(),
        user_id: currentUser?.id
    };
    
    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð±Ð¾Ñ‚Ñƒ Ñ‡ÐµÑ€ÐµÐ· Telegram Web App
    tg.sendData(JSON.stringify(syncData));
    
    // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ð± ÑƒÑÐ¿ÐµÑ…Ðµ
    showSyncMessage('âœ… Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð±Ð¾Ñ‚Ñƒ! ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ‡Ð°Ñ‚ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼.');
}

// Load from bot - Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñƒ Ð±Ð¾Ñ‚Ð°
function loadFromBot() {
    // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÑŽ
    showSyncMessage('ðŸ“¥ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð±Ð¾Ñ‚Ñƒ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ /sync_to_webapp Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ');
}

// Show sync message
function showSyncMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #4CAF50;
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        max-width: 80%;
        text-align: center;
    `;
    messageDiv.textContent = message;
    
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.remove();
    }, 4000);
}

// Handle Enter key in input
document.getElementById('itemInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        addItem();
    }
});

// Add sync buttons to the interface
function addSyncButtons() {
    const header = document.querySelector('.header');
    
    const syncButtons = document.createElement('div');
    syncButtons.style.cssText = `
        display: flex;
        gap: 10px;
        margin-top: 10px;
        justify-content: center;
    `;
    
    syncButtons.innerHTML = `
        <button onclick="syncWithBot()" style="
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        ">ðŸ“¤ ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ñƒ</button>
        
        <button onclick="loadFromBot()" style="
            background: #FF9800;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        ">ðŸ“¥ Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð¾Ñ‚ Ð±Ð¾Ñ‚Ð°</button>
    `;
    
    header.appendChild(syncButtons);
}

// Load items when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadItems();
    addSyncButtons();
});
